name: CI

on:
  pull_request:
  push:
    branches:
      - 'main'

jobs:
  run_tests:
    name: run tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v26

      # Binary cache is maintained in update_cache.yml; see comments there for details.
      - uses: zombiezen/setup-nix-cache-action@v0.4.0
        with:
          substituters: s3://mfenniak-multicorn2-nix-cache?region=us-west-2
          trusted_public_keys: mfenniak-multicorn2-nix-cache:mldk0J26tzkCmqihQKOiyuAm1HAs2CHdIZC0ESr56ZA=

      # Seems to be a bug in setup-nix-cache-action where, even though we're only providing a trusted_public_keys input
      # and no secret_keys input, it still tries to create a post-build-hook that will push packages to the cache.  This
      # is a hacky workaround to remove that hook -- we find the post-build-hook created by setup-nix-cache-action and
      # truncate it to 0 bytes so it does nothing.
      - run: sudo find /home/runner/work/_temp -type d -name 'setup-nix-cache-action-*' -exec sh -c 'truncate -s 0 "$1"/post-build-hook' _ {} \;

      - run: nix build .#allTestSuites
      # (No exit on test failure, so logs are always copied into ./result)

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pg_regress-logs
          path: ./result/test_output

      # Now, parse result_code so the job fails if tests failed
      - name: Fail if tests failed
        if: always()  # ensure we do this even if the build otherwise "succeeded"
        run: |
          if [ -f ./result/test_output/.result_code ]; then
            rc=$(cat ./result/test_output/.result_code)
            echo "Test exit code was: $rc"
            if [ "$rc" -ne 0 ]; then
              echo "The tests had failures."
              exit 1
            fi
          else
            echo "No .result_code found, something's off!"
            exit 1
          fi

